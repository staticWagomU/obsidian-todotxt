# Obsidian Todo.txt プラグイン 要件仕様書

## 1. 概要

### 1.1 目的
Obsidian 内で todo.txt 形式のファイルを管理・表示するためのプラグインを開発する。

### 1.2 todo.txt とは
todo.txt は、プレーンテキストベースのタスク管理フォーマット。以下の特徴を持つ：
- **ソフトウェア非依存**: プレーンテキストなので任意のエディタで編集可能
- **人間可読**: 特別なツールなしでも内容を理解できる
- **ソート可能**: アルファベット順ソートで意味のある順序になる設計

---

## 2. todo.txt フォーマット仕様

### 2.1 基本構造
```
[x] [(A)] [YYYY-MM-DD] [YYYY-MM-DD] <description> [+project] [@context] [key:value]
 ↑    ↑        ↑            ↑           ↑           ↑          ↑         ↑
完了  優先度  完了日      作成日      説明文     プロジェクト コンテキスト タグ
```

### 2.2 未完了タスクのルール

| ルール | 説明 | 例 |
|--------|------|-----|
| **優先度** | `(A)` - `(Z)` の大文字。**必ず行頭**に配置 | `(A) Call Mom` |
| **作成日** | `YYYY-MM-DD` 形式。優先度の直後（なければ行頭） | `(A) 2024-01-08 Call Mom` |
| **プロジェクト** | `+` に続く非空白文字列。説明文内のどこでも可 | `+GarageSale` |
| **コンテキスト** | `@` に続く非空白文字列。説明文内のどこでも可 | `@phone` |
| **タグ** | `key:value` 形式。コロン1つで区切り | `due:2024-01-15` |

### 2.3 完了タスクのルール

| ルール | 説明 | 例 |
|--------|------|-----|
| **完了マーク** | 小文字 `x` + スペースで開始 | `x 2024-01-08 Call Mom` |
| **完了日** | `x` の直後に `YYYY-MM-DD` 形式 | `x 2024-01-08 2024-01-07 Call Mom` |

### 2.4 拡張タグ（key:value 形式）

| タグ | 説明 | 例 |
|------|------|-----|
| `due:` | 期限日 | `due:2024-01-15` |
| `t:` | しきい値日（この日まで非表示） | `t:2024-01-10` |
| `rec:` | 繰り返し設定 | `rec:+7d`（完了から7日後）, `rec:7d`（期限から7日後） |
| `pri:` | 完了時の優先度保存用 | `pri:A` |

### 2.5 フォーマット例
```
(A) 2024-01-08 Call Mom @phone +Family
(B) Schedule Goodwill pickup +GarageSale @phone due:2024-01-15
Post signs around the neighborhood +GarageSale
x 2024-01-07 2024-01-05 Buy groceries @store
@GroceryStore pies
Learn how to add 2+2
```

---

## 3. プラグイン機能要件

### 3.1 ファイル関連

| 機能ID | 機能 | 優先度 | 説明 |
|--------|------|--------|------|
| F-FILE-01 | .txt / .todotxt ファイルの認識 | 必須 | 指定拡張子のファイルを専用ビューで開く |
| F-FILE-02 | ファイルの読み込み | 必須 | todo.txt 形式をパースしてタスク一覧に変換 |
| F-FILE-03 | ファイルの保存 | 必須 | タスク変更をファイルに書き戻す |
| F-FILE-04 | 追加拡張子の設定 | 任意 | 設定で対象拡張子を追加可能 |

### 3.2 タスク管理

| 機能ID | 機能 | 優先度 | 説明 |
|--------|------|--------|------|
| F-TASK-01 | タスク一覧表示 | 必須 | パースしたタスクをリスト形式で表示 |
| F-TASK-02 | タスク完了トグル | 必須 | チェックボックスで完了/未完了を切り替え |
| F-TASK-03 | タスク追加 | 必須 | 新規タスクを作成（作成日を自動付与） |
| F-TASK-04 | タスク編集 | 必須 | 既存タスクの内容を編集 |
| F-TASK-05 | タスク削除 | 必須 | 確認ダイアログ付きで削除 |
| F-TASK-06 | 優先度の視覚的表示 | 必須 | 優先度に応じた色分けバッジ |

### 3.3 フィルタリング・ソート

| 機能ID | 機能 | 優先度 | 説明 |
|--------|------|--------|------|
| F-FILTER-01 | 優先度フィルタ | 必須 | 指定優先度以上のタスクのみ表示 |
| F-FILTER-02 | テキスト検索 | 必須 | 説明文での絞り込み |
| F-FILTER-03 | プロジェクト/コンテキストでグルーピング | 必須 | 選択した軸でタスクをグループ化 |
| F-SORT-01 | タスクのソート | 必須 | 未完了→完了、優先度順、テキスト順 |

### 3.4 日付関連

| 機能ID | 機能 | 優先度 | 説明 |
|--------|------|--------|------|
| F-DATE-01 | 期限表示 | 必須 | `due:` タグの日付を視覚的に表示 |
| F-DATE-02 | 期限ハイライト | 推奨 | 過去・間近・未来で色分け |
| F-DATE-03 | しきい値日サポート | 推奨 | `t:` 以前のタスクをグレーアウト |

### 3.5 拡張機能

| 機能ID | 機能 | 優先度 | 説明 |
|--------|------|--------|------|
| F-EXT-01 | Obsidian 内部リンク | 必須 | `[[Note]]` 形式のリンクをサポート |
| F-EXT-02 | 外部リンク | 必須 | `[text](url)` 形式のリンクをサポート |
| F-EXT-03 | 繰り返しタスク | 必須 | `rec:` タグで自動的に次のタスクを生成 |
| F-EXT-04 | 優先度保存 | 推奨 | 完了時に `pri:` タグで優先度を保存 |

### 3.6 設定

| 機能ID | 機能 | 優先度 | 説明 |
|--------|------|--------|------|
| F-SET-01 | デフォルト優先度フィルタ | 推奨 | 起動時のフィルタ初期値 |
| F-SET-02 | デフォルトグルーピング | 推奨 | プロジェクト or コンテキスト |
| F-SET-03 | デフォルトグループ名 | 推奨 | タグなしタスクのグループ名 |
| F-SET-04 | 追加ファイル拡張子 | 任意 | 対象とする追加拡張子 |

### 3.7 フォームUI

| 機能ID | 機能 | 優先度 | 説明 |
|--------|------|--------|------|
| F-FORM-01 | 構造化タスク入力フォーム | 必須 | タイトル、詳細、優先度、日付等を個別に入力 |
| F-FORM-02 | デートピッカー | 必須 | 期限日・開始日をカレンダーから選択 |
| F-FORM-03 | コンボボックス（プロジェクト） | 必須 | 既存+新規作成可能なドロップダウン |
| F-FORM-04 | コンボボックス（コンテキスト） | 必須 | 既存+新規作成可能なドロップダウン |
| F-FORM-05 | リアルタイムプレビュー | 推奨 | todo.txt形式でのプレビュー表示 |
| F-FORM-06 | 手動編集モード | 任意 | 上級者向けの直接テキスト編集 |

**デフォルト値:**
- **デフォルト優先度**: なし（本当に重要なタスクだけに優先度を付ける運用）
- **デフォルト作成日**: 今日の日付（自動付与）

---

## 4. UI/UX 要件

### 4.1 ビュー構成
```
┌─────────────────────────────────────────────┐
│ [コントロールバー]                            │
│ ┌───────┐ ┌───────────┐ ┌──────┐ ┌───┐     │
│ │優先度 ▼│ │グループ方式▼│ │🔍検索 │ │ + │     │
│ └───────┘ └───────────┘ └──────┘ └───┘     │
├─────────────────────────────────────────────┤
│ [タスク一覧]                                  │
│                                             │
│ ▼ +ProjectA                                  │
│   ☐ (A) Call client @phone                   │
│   ☑ Buy supplies due:2024-01-10              │
│                                             │
│ ▼ +ProjectB                                  │
│   ☐ Review document @computer                │
│                                             │
│ ▼ (デフォルト)                                │
│   ☐ Random task                              │
│                                             │
└─────────────────────────────────────────────┘
```

### 4.2 タスクアイテム表示
```
☐ (A) Task description +Project @context due:2024-01-15 [✏️] [🗑️]
↑   ↑         ↑           ↑        ↑           ↑          ↑    ↑
チェック 優先度バッジ 説明文   プロジェクト コンテキスト 期限    編集  削除
```

### 4.3 インタラクション
- **チェックボックス**: タスク完了/未完了のトグル
- **タスク行クリック or ロングプレス**: 編集ダイアログを開く
- **キーボードショートカット**:
  - `Ctrl+N`: 新規タスク追加
  - `Ctrl+/`: 検索フォーカス
  - `e` / `Enter`: 編集
  - `d`: 削除

---

## 5. データモデル

### 5.1 Todo クラス
```typescript
interface Todo {
  id: number;                    // 一意識別子（行番号ベース）
  completed: boolean;            // 完了フラグ
  completedDate?: string;        // 完了日 (YYYY-MM-DD)
  priority?: string;             // 優先度 (A-Z)
  createDate?: string;           // 作成日 (YYYY-MM-DD)
  description: TodoComponent[];  // 説明文（パース済み）
}
```

### 5.2 TodoComponent 型
```typescript
type TodoComponent =
  | TodoWord        // プレーンテキスト
  | TodoProject     // +project
  | TodoContext     // @context
  | TodoTag         // key:value
  | TodoInternalLink // [[link]]
  | TodoExternalLink; // [text](url)
```

---

## 6. 技術要件

### 6.1 開発環境
- **言語**: TypeScript
- **UI フレームワーク**: React
- **ビルドツール**: esbuild
- **パーサー**: PEG.js (Peggy) または手書きパーサー
- **日付計算**: Luxon（繰り返しタスクの日付計算用）

### 6.2 Obsidian API
- `Plugin`: プラグインライフサイクル
- `TextFileView`: カスタムファイルビュー
- `PluginSettingTab`: 設定 UI
- `registerView()`: ビュー登録
- `registerExtensions()`: ファイル拡張子登録

### 6.3 ファイル構成（予定）
```
src/
├── main.ts              # プラグインエントリーポイント
├── view.tsx             # TodotxtView (TextFileView 拡張)
├── lib/
│   ├── todo.ts          # Todo データモデル
│   └── parser.ts        # todo.txt パーサー
├── ui/
│   ├── TodosView.tsx    # メインビューコンポーネント
│   ├── TodosList.tsx    # タスクリストコンポーネント
│   ├── TodoItem.tsx     # 個別タスクコンポーネント
│   └── dialogs/         # ダイアログコンポーネント
└── settings.ts          # 設定管理
```

---

## 7. 優先度と開発フェーズ

**対象スコープ**: Phase 1〜3（繰り返しタスクを必須機能として含む）

### Phase 1: MVP（最小限の実用製品）
- F-FILE-01, 02, 03: ファイル読み書き
- F-TASK-01, 02, 03, 04, 05: 基本CRUD
- F-SORT-01: ソート
- 基本的なパーサー実装

### Phase 2: フィルタリング & UI 改善
- F-TASK-06: 優先度バッジ
- F-FILTER-01, 02, 03: フィルタリング機能
- F-DATE-01, 02: 期限表示

### Phase 3: 拡張機能 + 設定
- F-DATE-03: しきい値日
- F-EXT-01, 02: リンクサポート
- F-EXT-03: 繰り返しタスク（必須）
- F-EXT-04: 優先度保存
- F-SET-*: 設定機能

---

## 8. 参考資料

- [todo.txt 公式フォーマット](https://github.com/todotxt/todo.txt)
- [Obsidian Plugin API](https://docs.obsidian.md/Plugins)
- 参考実装: `refferencies/obsidian-todotxt-plugin/`
- 参考実装: `refferencies/obsidian-kanban/`
