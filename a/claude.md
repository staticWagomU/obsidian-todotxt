# todo.txt パーサー テスト設計書

## 1. todo.txt フォーマット仕様

```
### 公式仕様に基づく構文定義

完全なタスク行の構文:
[x ] [(A-Z) ] [completion_date ] [creation_date ] description [+project...] [@context...] [key:value...]

### 各要素の詳細

1. 完了マーク (completion)
   - 形式: "x " (小文字x + 半角スペース)
   - 位置: 行頭のみ有効
   - 省略可能

2. 優先度 (priority)
   - 形式: "(A)" ～ "(Z)" (大文字のみ)
   - 位置: 行頭、または完了マーク直後
   - 省略可能
   - 完了タスクでは優先度は無視されることが多い

3. 日付 (dates)
   - 形式: YYYY-MM-DD
   - 完了日: 完了マークの直後（完了タスクのみ）
   - 作成日: 完了日の後、または優先度の後
   - 省略可能

4. 本文 (description)
   - 必須要素
   - 空白を含む自由テキスト

5. プロジェクト (project)
   - 形式: +project_name
   - 位置: 本文中どこでも可
   - 複数指定可能
   - 使用可能文字: 英数字、ハイフン、アンダースコア

6. コンテキスト (context)
   - 形式: @context_name
   - 位置: 本文中どこでも可
   - 複数指定可能
   - 使用可能文字: 英数字、ハイフン、アンダースコア

7. タグ (key:value)
   - 形式: key:value (コロン区切り)
   - 位置: 本文中どこでも可
   - 複数指定可能
   - キーにスペース不可
```

---

## 2. テストケース一覧

### 2.1 基本パターン（正常系）

```
| ID     | カテゴリ | 入力                                          | 期待結果                                                         |
|--------|----------|-----------------------------------------------|------------------------------------------------------------------|
| B-001  | 基本     | `タスクを完了する`                            | description: "タスクを完了する"                                   |
| B-002  | 基本     | `(A) 重要なタスク`                            | priority: "A", description: "重要なタスク"                        |
| B-003  | 基本     | `x 完了したタスク`                            | completed: true, description: "完了したタスク"                    |
| B-004  | 基本     | `2024-01-15 作成日付きタスク`                 | creation_date: "2024-01-15", description: "作成日付きタスク"      |
| B-005  | 基本     | `タスク +project1`                            | description: "タスク", projects: ["+project1"]                    |
| B-006  | 基本     | `タスク @home`                                | description: "タスク", contexts: ["@home"]                        |
| B-007  | 基本     | `タスク due:2024-12-31`                       | description: "タスク", tags: {due: "2024-12-31"}                  |
```

### 2.2 複数要素の組み合わせ

```
| ID     | カテゴリ | 入力                                                                      | 期待結果                                                                                                      |
|--------|----------|---------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------|
| C-001  | 組合せ   | `(A) 2024-01-15 優先度と日付`                                             | priority: "A", creation_date: "2024-01-15", description: "優先度と日付"                                        |
| C-002  | 組合せ   | `x 2024-01-20 完了タスク`                                                 | completed: true, completion_date: "2024-01-20", description: "完了タスク"                                      |
| C-003  | 組合せ   | `x 2024-01-20 2024-01-15 両日付あり`                                      | completed: true, completion_date: "2024-01-20", creation_date: "2024-01-15", description: "両日付あり"         |
| C-004  | 組合せ   | `(B) タスク +proj @ctx`                                                   | priority: "B", projects: ["+proj"], contexts: ["@ctx"], description: "タスク"                                  |
| C-005  | 組合せ   | `タスク +proj1 +proj2`                                                    | projects: ["+proj1", "+proj2"], description: "タスク"                                                          |
| C-006  | 組合せ   | `タスク @home @work`                                                      | contexts: ["@home", "@work"], description: "タスク"                                                            |
| C-007  | 組合せ   | `タスク due:2024-12-31 priority:high`                                     | tags: {due: "2024-12-31", priority: "high"}, description: "タスク"                                             |
| C-008  | 組合せ   | `x (A) 2024-01-20 2024-01-15 全要素 +proj @ctx due:2024-12-31`            | completed: true, priority: "A"*, completion_date: "2024-01-20", creation_date: "2024-01-15", projects: ["+proj"], contexts: ["@ctx"], tags: {due: "2024-12-31"} |
| C-009  | 組合せ   | `中間に +project ある @context タスク`                                    | projects: ["+project"], contexts: ["@context"], description: "中間に ある タスク"                              |
| C-010  | 組合せ   | `+project @context タグ先頭`                                              | projects: ["+project"], contexts: ["@context"], description: "タグ先頭"                                        |
```

*注: 完了タスクの優先度の扱いは実装依存

### 2.3 優先度のエッジケース

```
| ID     | カテゴリ   | 入力                        | 期待結果                                                    |
|--------|------------|-----------------------------|-------------------------------------------------------------|
| P-001  | 優先度     | `(A) 最高優先度`            | priority: "A"                                                |
| P-002  | 優先度     | `(Z) 最低優先度`            | priority: "Z"                                                |
| P-003  | 優先度     | `(M) 中間優先度`            | priority: "M"                                                |
| P-004  | 優先度異常 | `(a) 小文字`                | priority: null, description: "(a) 小文字"                    |
| P-005  | 優先度異常 | `(1) 数字`                  | priority: null, description: "(1) 数字"                      |
| P-006  | 優先度異常 | `(AA) 複数文字`             | priority: null, description: "(AA) 複数文字"                 |
| P-007  | 優先度異常 | `() 空`                     | priority: null, description: "() 空"                         |
| P-008  | 優先度異常 | `( A) スペース含む`         | priority: null, description: "( A) スペース含む"             |
| P-009  | 優先度異常 | `(A)スペースなし`           | priority: null, description: "(A)スペースなし"               |
| P-010  | 優先度異常 | `タスク (A) 途中`           | priority: null, description: "タスク (A) 途中"               |
| P-011  | 優先度異常 | `(Á) アクセント付き`        | priority: null, description: "(Á) アクセント付き"            |
```

### 2.4 日付のエッジケース

```
| ID     | カテゴリ   | 入力                                    | 期待結果                                                          |
|--------|------------|-----------------------------------------|-------------------------------------------------------------------|
| D-001  | 日付       | `2024-01-01 年始`                       | creation_date: "2024-01-01"                                        |
| D-002  | 日付       | `2024-12-31 年末`                       | creation_date: "2024-12-31"                                        |
| D-003  | 日付       | `2024-02-29 うるう年`                   | creation_date: "2024-02-29"                                        |
| D-004  | 日付       | `2000-01-01 2000年`                     | creation_date: "2000-01-01"                                        |
| D-005  | 日付       | `9999-12-31 遠い未来`                   | creation_date: "9999-12-31"                                        |
| D-006  | 日付異常   | `2024/01/15 スラッシュ`                 | creation_date: null, description: "2024/01/15 スラッシュ"          |
| D-007  | 日付異常   | `2024-1-15 ゼロパディングなし`          | creation_date: null, description: "2024-1-15 ゼロパディングなし"   |
| D-008  | 日付異常   | `24-01-15 2桁年`                        | creation_date: null, description: "24-01-15 2桁年"                 |
| D-009  | 日付異常   | `2024-13-01 無効な月`                   | 実装依存（バリデーション有無）                                     |
| D-010  | 日付異常   | `2024-02-30 無効な日`                   | 実装依存（バリデーション有無）                                     |
| D-011  | 日付異常   | `2023-02-29 うるう年でない`             | 実装依存（バリデーション有無）                                     |
| D-012  | 日付異常   | `タスク 2024-01-15 途中の日付`          | creation_date: null, description: "タスク 2024-01-15 途中の日付"   |
| D-013  | 日付       | `x 2024-01-15 完了日のみ`               | completed: true, completion_date: "2024-01-15"                     |
| D-014  | 日付異常   | `2024-01-15 2024-01-20 作成>完了`       | creation_date: "2024-01-15", 2番目は本文扱いまたはエラー          |
```

### 2.5 プロジェクトのエッジケース

```
| ID     | カテゴリ     | 入力                              | 期待結果                                                    |
|--------|--------------|-----------------------------------|-------------------------------------------------------------|
| PR-001 | プロジェクト | `+a 最短`                         | projects: ["+a"]                                             |
| PR-002 | プロジェクト | `+Project_Name-123 複合`          | projects: ["+Project_Name-123"]                              |
| PR-003 | プロジェクト | `+日本語 日本語プロジェクト`      | 実装依存（Unicode対応）                                      |
| PR-004 | プロジェクト | `+UPPERCASE 大文字`               | projects: ["+UPPERCASE"]                                     |
| PR-005 | プロジェクト | `+lowercase 小文字`               | projects: ["+lowercase"]                                     |
| PR-006 | プロジェクト | `+CamelCase キャメル`             | projects: ["+CamelCase"]                                     |
| PR-007 | プロジェクト異常 | `+ スペース後`                | projects: [], description: "+ スペース後"                    |
| PR-008 | プロジェクト異常 | `タスク+ 末尾プラス`          | projects: [], description: "タスク+ 末尾プラス"              |
| PR-009 | プロジェクト | `+a+b 連続`                       | projects: ["+a+b"] または ["+a", "+b"]（実装依存）           |
| PR-010 | プロジェクト | `++double ダブルプラス`           | 実装依存                                                     |
| PR-011 | プロジェクト | `タスク+inline インライン`        | projects: [], description: "タスク+inline インライン"        |
```

### 2.6 コンテキストのエッジケース

```
| ID     | カテゴリ       | 入力                             | 期待結果                                                   |
|--------|----------------|----------------------------------|------------------------------------------------------------|
| CX-001 | コンテキスト   | `@a 最短`                        | contexts: ["@a"]                                            |
| CX-002 | コンテキスト   | `@home_office-2024 複合`         | contexts: ["@home_office-2024"]                             |
| CX-003 | コンテキスト   | `@会社 日本語コンテキスト`       | 実装依存（Unicode対応）                                     |
| CX-004 | コンテキスト異常 | `@ 空`                         | contexts: [], description: "@ 空"                           |
| CX-005 | コンテキスト異常 | `email@example.com メールアドレス` | contexts: [], description: "email@example.com メールアドレス" |
| CX-006 | コンテキスト   | `@home @work @mobile 複数`       | contexts: ["@home", "@work", "@mobile"]                      |
| CX-007 | コンテキスト   | `@@double ダブルアット`          | 実装依存                                                    |
| CX-008 | コンテキスト   | `タスク@inline インライン`       | contexts: [], description: "タスク@inline インライン"       |
```

### 2.7 タグのエッジケース

```
| ID     | カテゴリ | 入力                                  | 期待結果                                                     |
|--------|----------|---------------------------------------|--------------------------------------------------------------|
| T-001  | タグ     | `due:2024-12-31 日付値`               | tags: {due: "2024-12-31"}                                     |
| T-002  | タグ     | `pri:A 単一文字値`                    | tags: {pri: "A"}                                              |
| T-003  | タグ     | `key:value_with-special 複合値`       | tags: {key: "value_with-special"}                             |
| T-004  | タグ     | `a:b 最短`                            | tags: {a: "b"}                                                |
| T-005  | タグ異常 | `key: 空値`                           | 実装依存（空文字列または無視）                                |
| T-006  | タグ異常 | `:value キーなし`                     | tags: {}, description: ":value キーなし"                      |
| T-007  | タグ異常 | `key:val:ue コロン複数`               | tags: {key: "val:ue"} または {key: "val"}（実装依存）         |
| T-008  | タグ     | `http://example.com URL`              | tags: {http: "//example.com"} または本文扱い（実装依存）      |
| T-009  | タグ     | `time:10:30 時刻`                     | tags: {time: "10:30"} または {time: "10"}（実装依存）         |
| T-010  | タグ     | `key1:val1 key2:val2 複数タグ`        | tags: {key1: "val1", key2: "val2"}                            |
| T-011  | タグ異常 | `key :value スペースあり`             | tags: {}, description: "key :value スペースあり"              |
| T-012  | タグ     | `キー:値 日本語タグ`                  | 実装依存（Unicode対応）                                       |
```

### 2.8 完了マークのエッジケース

```
| ID     | カテゴリ   | 入力                              | 期待結果                                                   |
|--------|------------|-----------------------------------|------------------------------------------------------------|
| X-001  | 完了       | `x タスク`                        | completed: true                                             |
| X-002  | 完了異常   | `X タスク 大文字`                 | completed: false, description: "X タスク 大文字"            |
| X-003  | 完了異常   | `xタスク スペースなし`            | completed: false, description: "xタスク スペースなし"       |
| X-004  | 完了異常   | ` x タスク 先頭スペース`          | completed: false, description: "x タスク"（または実装依存） |
| X-005  | 完了異常   | `タスク x 途中`                   | completed: false, description: "タスク x 途中"              |
| X-006  | 完了異常   | `xx タスク 重複`                  | completed: false, description: "xx タスク 重複"             |
| X-007  | 完了       | `x  タスク スペース2つ`           | completed: true, description: " タスク スペース2つ"         |
```

### 2.9 空白・特殊文字

```
| ID     | カテゴリ   | 入力                                    | 期待結果                                                     |
|--------|------------|-----------------------------------------|--------------------------------------------------------------|
| S-001  | 空白       | `タスク  複数スペース  あり`            | description: "タスク  複数スペース  あり"（保持）            |
| S-002  | 空白       | `  先頭スペース`                        | description: "先頭スペース"（トリム）または実装依存          |
| S-003  | 空白       | `末尾スペース  `                        | description: "末尾スペース"（トリム）または実装依存          |
| S-004  | 空白       | `タスク\tタブ`                          | 実装依存（タブの扱い）                                       |
| S-005  | 特殊文字   | `タスク "引用符" あり`                  | description: `タスク "引用符" あり`                          |
| S-006  | 特殊文字   | `タスク 'シングルクォート' あり`        | description: `タスク 'シングルクォート' あり`                |
| S-007  | 特殊文字   | `タスク \`バッククォート\` あり`        | description: `タスク \`バッククォート\` あり`                |
| S-008  | 特殊文字   | `タスク <html> タグ`                    | description: `タスク <html> タグ`                            |
| S-009  | 特殊文字   | `タスク & アンパサンド`                 | description: `タスク & アンパサンド`                         |
| S-010  | 特殊文字   | `タスク \\ バックスラッシュ`            | description: `タスク \\ バックスラッシュ`                    |
| S-011  | 特殊文字   | `タスク 日本語 🎉 絵文字`               | description: `タスク 日本語 🎉 絵文字`（Unicode対応）        |
| S-012  | 特殊文字   | `タスク\n改行`                          | 単一行として処理（改行は行区切り）                           |
```

### 2.10 複数行パース

```
| ID     | カテゴリ | 入力                                                                      | 期待結果                                                             |
|--------|----------|---------------------------------------------------------------------------|----------------------------------------------------------------------|
| M-001  | 複数行   | `タスク1\nタスク2`                                                        | 2件のタスク: ["タスク1", "タスク2"]                                   |
| M-002  | 複数行   | `(A) タスク1\n(B) タスク2`                                                | 2件: [{priority:"A"}, {priority:"B"}]                                 |
| M-003  | 複数行   | `タスク1\n\nタスク2`                                                      | 2件（空行スキップ）または3件（空タスク含む）                          |
| M-004  | 複数行   | `タスク1\n   \nタスク2`                                                   | 空白のみの行の扱い（スキップまたはエラー）                            |
| M-005  | 複数行   | `# コメント\nタスク`                                                      | 実装依存（コメント行対応）                                            |
| M-006  | 複数行   | `タスク1\r\nタスク2`                                                      | Windows改行コード対応: 2件                                            |
| M-007  | 複数行   | `タスク1\rタスク2`                                                        | CR改行コード対応: 2件または実装依存                                   |
| M-008  | 複数行   | 空文字列 ``                                                               | 0件のタスク                                                           |
| M-009  | 複数行   | `\n\n\n`                                                                  | 0件（空行のみ）                                                       |
```

### 2.11 異常系・境界値

```
| ID     | カテゴリ | 入力                                                                      | 期待結果                                                             |
|--------|----------|---------------------------------------------------------------------------|----------------------------------------------------------------------|
| E-001  | 異常     | `` (空文字列)                                                             | パースエラーまたは空タスク                                            |
| E-002  | 異常     | `   ` (スペースのみ)                                                      | パースエラーまたは空タスク                                            |
| E-003  | 境界     | `a` (1文字)                                                               | description: "a"                                                      |
| E-004  | 境界     | 1000文字のタスク                                                          | 正常にパース（長いタスク対応）                                        |
| E-005  | 境界     | 100個の+projectを含むタスク                                               | 100個のprojects配列                                                   |
| E-006  | 境界     | 100個の@contextを含むタスク                                               | 100個のcontexts配列                                                   |
| E-007  | 境界     | 100個のkey:valueを含むタスク                                              | 100個のtags                                                           |
| E-008  | 異常     | `\x00` (NULLバイト)                                                       | エラーまたは無視                                                      |
| E-009  | 異常     | 不正なUTF-8シーケンス                                                     | エラーまたはリプレース                                                |
| E-010  | 境界     | 10000行のファイル                                                         | 全行パース（パフォーマンス確認）                                      |
```

### 2.12 実用的な複合パターン

```
| ID     | カテゴリ | 入力                                                                                        | 期待結果                                                                                                                                               |
|--------|----------|---------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------|
| R-001  | 実用     | `(A) 2024-01-15 クライアントへ提案書送付 +sales @office due:2024-01-20`                     | priority:"A", creation_date:"2024-01-15", projects:["+sales"], contexts:["@office"], tags:{due:"2024-01-20"}                                            |
| R-002  | 実用     | `x 2024-01-18 2024-01-10 バグ修正完了 +webapp @dev issue:123`                               | completed:true, completion_date:"2024-01-18", creation_date:"2024-01-10", projects:["+webapp"], contexts:["@dev"], tags:{issue:"123"}                   |
| R-003  | 実用     | `電話する +personal @phone rec:weekly`                                                      | projects:["+personal"], contexts:["@phone"], tags:{rec:"weekly"}                                                                                       |
| R-004  | 実用     | `(B) レポート作成 +work @computer est:2h due:2024-01-25 pri:high`                           | priority:"B", projects:["+work"], contexts:["@computer"], tags:{est:"2h", due:"2024-01-25", pri:"high"}                                                 |
| R-005  | 実用     | `2024-01-15 毎週のミーティング準備 +meeting @office rec:weekly`                              | creation_date:"2024-01-15", projects:["+meeting"], contexts:["@office"], tags:{rec:"weekly"}                                                           |
| R-006  | 実用     | `x (B) 2024-01-20 2024-01-01 年次レビュー完了 +hr @office note:Good_feedback`               | completed:true, priority:"B"*, completion_date:"2024-01-20", creation_date:"2024-01-01", projects:["+hr"], contexts:["@office"], tags:{note:"Good_feedback"} |
| R-007  | 実用     | `買い物リスト作成 +home +errands @weekend`                                                  | projects:["+home", "+errands"], contexts:["@weekend"]                                                                                                  |
| R-008  | 実用     | `Call John about +ProjectX @phone @waiting due:2024-02-01`                                  | projects:["+ProjectX"], contexts:["@phone", "@waiting"], tags:{due:"2024-02-01"}                                                                       |
```

---

## 3. テストデータファイル例

```txt
# === test_todo.txt ===
# テストデータファイル（コメント行は実装によって対応が異なる）

# 基本パターン
単純なタスク
(A) 優先度Aのタスク
(Z) 優先度Zのタスク
2024-01-15 日付付きタスク
x 完了したタスク

# 複合パターン
(A) 2024-01-15 優先度と日付
x 2024-01-20 2024-01-15 完了タスク（両日付）
(B) タスク本文 +project1 @context1 due:2024-12-31

# プロジェクトとコンテキスト
タスク +proj1 +proj2 複数プロジェクト
タスク @home @work 複数コンテキスト
混合タスク +project @context due:tomorrow

# エッジケース
(a) 小文字優先度（無効）
2024/01/15 スラッシュ日付（無効）
email@example.com メールアドレス含む
http://example.com URL含む
タスク key:val1:val2 コロン複数

# 実用的なタスク
(A) 2024-06-01 顧客ミーティング準備 +sales @office due:2024-06-05
x 2024-05-28 2024-05-20 四半期レポート完了 +reports @computer
(B) コードレビュー +dev @computer est:1h issue:456
毎日の運動 +health @home rec:daily
Call supplier about order +procurement @phone @waiting

# 特殊文字
タスク with "quotes" and 'apostrophes'
タスク with <html> tags
日本語タスク 🎉 絵文字付き

# 長いタスク（境界値テスト用）
(A) 2024-01-01 これは非常に長いタスクの説明文です。複数のプロジェクトとコンテキストを含みます。 +project1 +project2 +project3 @context1 @context2 @context3 due:2024-12-31 priority:high status:in-progress assigned:john created_by:admin
```

---

## 4. テストカバレッジサマリー

```
| カテゴリ                 | テストケース数 | カバー内容                                   |
|--------------------------|----------------|----------------------------------------------|
| 基本パターン             | 7              | 各要素の単独正常系                           |
| 複数要素の組み合わせ     | 10             | 2要素以上の組み合わせ                        |
| 優先度エッジケース       | 11             | A-Z、無効形式、位置異常                      |
| 日付エッジケース         | 14             | 形式、境界日付、無効日付                     |
| プロジェクトエッジケース | 11             | 形式、Unicode、無効形式                      |
| コンテキストエッジケース | 8              | 形式、メールアドレス、複数指定               |
| タグエッジケース         | 12             | 形式、コロン、URL、複数タグ                  |
| 完了マークエッジケース   | 7              | x形式、位置、大文字                          |
| 空白・特殊文字           | 12             | 空白、引用符、Unicode、絵文字                |
| 複数行パース             | 9              | 改行コード、空行、コメント                   |
| 異常系・境界値           | 10             | 空入力、長大入力、不正バイト                 |
| 実用的な複合パターン     | 8              | 実際の使用シーンを想定                       |
| **合計**                 | **109**        |                                              |
```

---

## 5. 実装時の注意点

```markdown
### パーサー実装で考慮すべき点

1. **優先度の解釈**
   - 完了タスク(x)の優先度をどう扱うか（保持/削除/無視）
   - 公式仕様では完了時に優先度を削除することを推奨

2. **日付のバリデーション**
   - フォーマットチェックのみか、実在日付チェックまで行うか
   - 2024-02-30のような無効日付の扱い

3. **Unicode対応**
   - プロジェクト名、コンテキスト名に日本語等を許可するか
   - 絵文字の扱い

4. **区切り文字の厳密性**
   - `タスク+project`（スペースなし）を認識するか
   - `key : value`（スペースあり）を認識するか

5. **コメント行**
   - `#`で始まる行をコメントとして扱うか
   - 公式仕様には明記なし

6. **エラーハンドリング**
   - 無効な行をスキップするか、エラーを返すか
   - 部分的に有効な行の扱い
```
